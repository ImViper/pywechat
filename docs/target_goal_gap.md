# 目标差距记录（命中后 10 条评论 < 1 秒）

更新时间：2026-02-10（按最新代码扫描）
流程图：`docs/hook_flow_overview.md`

## 1. 最终目标

1. 命中目标朋友圈后自动发送 10 条评论。
2. 强性能目标：10 条总耗时 `< 1 秒`。
3. 成功口径：单轮 `10/10`，且连续多轮 P95 `< 1 秒`。

## 2. 最新基线（已验证）

- `piggyback_comment`：已出现 10/10 成功样本。
- 最新稳定样本：`5591ms / 10 条`（约 `559ms/条`，串行级吞吐）。
- 直接差距：`5591 - 1000 = 4591ms`。
- 提速要求：至少 `5.59x`（或总时延下降约 `82.1%`）。

## 3. 当前实现到哪里了

1. `parallel_comment` 已实现并接到 Python Bridge。
2. `piggyback_comment` 已实现批量入队，并在 hook 回调期 drain。
3. hook 回调中已存在并行执行分支（受 `max_concurrency` 与 `g_cached_req_0x368_valid` 约束）。
4. `request->+0x368` 缓存与 worker 预填充逻辑已在代码中。
5. `0xb91e90` TLS accessor 的“函数级 hook 方案”目前仍是分析与设计状态，尚未在代码安装。

## 4. 为什么还没达标

### 4.1 并行能力尚未完成“稳定验收”

- 当前只有“单次 10/10 成功 + 秒级耗时”样本。
- 缺少连续多轮（多并发级别）统计，无法证明稳定达标。

### 4.2 共享 `arg1` 的线程安全风险仍在

- piggyback 并行路径共享同一组 `arg1/arg2/arg3`。
- 如果 `g_original_fn` 内部存在写路径或隐式线程局部依赖，可能随机失败或崩溃。

### 4.3 上层判定口径偏宽

- `CommentDispatcher.post_batch_comments()` 当前是 `succeeded > 0` 即判并发可用。
- 这不等于你的最终口径 `10/10`。

### 4.4 主流程尚未默认走批量发送

- `moments_ext` 仍以逐条 `post_comment()` 为主，批量优化收益未完整落到端到端主链路。

## 5. 距离目标“还差多久”的工程化判断

按目前代码状态，距离目标还差两个里程碑：

1. 技术里程碑：把 piggyback 并发从“可运行”收敛到“稳定 10/10”。
2. 验收里程碑：形成连续多轮 `<1s` 的可复现实验数据。

若并行分支在 `2 -> 4 -> 8 -> 10` 分级压测中稳定，目标已进入可冲刺区间；若出现并发竞争或 TLS 依赖回归，则仍需额外一轮底层修复（例如继续推进 `0xb91e90` 方案）。

## 6. 达标前的最小必做项（P0）

1. 固化硬冲刺脚本：一次下发 10 条，禁用 UI fallback 干扰。
2. 判定收紧：并发可用必须 `succeeded == total`。
3. 分级压测：`2/4/8/10` 并发，每级多轮，输出成功率与耗时分布。
4. 形成统一报表：总耗时、P50/P95、失败分类（SEH/timeout/null return/限流）。
