# 目标差距记录（命中后 10 条评论 < 1 秒）

更新时间：2026-02-10（按最新代码扫描）
流程图：`docs/hook/hook_flow_overview.md`

## 1. 最终目标

1. 命中目标朋友圈后自动发送 10 条评论。
2. 强性能目标：10 条总耗时 `< 1 秒`。
3. 成功口径：单轮 `10/10`，且连续多轮 P95 `< 1 秒`。

## 2. 最新基线（已验证）

- `piggyback_comment`：已出现 10/10 成功样本。
- 最新稳定样本：`5591ms / 10 条`（约 `559ms/条`，串行级吞吐）。
- 直接差距：`5591 - 1000 = 4591ms`。
- 提速要求：至少 `5.59x`（或总时延下降约 `82.1%`）。

## 3. 当前实现到哪里了

1. `parallel_comment` 已实现并接到 Python Bridge。
2. `piggyback_comment` 已实现批量入队，并在 hook 回调期 drain。
3. hook 回调中已存在并行执行分支（受 `max_concurrency` 与 `g_cached_req_0x368_valid` 约束）。
4. `request->+0x368` 缓存与 worker 预填充逻辑已在代码中。
5. `0xb91e90` TLS accessor 的“函数级 hook 方案”目前仍是分析与设计状态，尚未在代码安装。

## 4. 为什么还没达标

### 4.1 并行能力尚未完成“稳定验收”

- 当前只有“单次 10/10 成功 + 秒级耗时”样本。
- 缺少连续多轮（多并发级别）统计，无法证明稳定达标。

### 4.2 共享 `arg1` 的线程安全风险仍在

- piggyback 并行路径共享同一组 `arg1/arg2/arg3`。
- 如果 `g_original_fn` 内部存在写路径或隐式线程局部依赖，可能随机失败或崩溃。

### 4.3 上层判定口径偏宽

- `CommentDispatcher.post_batch_comments()` 当前是 `succeeded > 0` 即判并发可用。
- 这不等于你的最终口径 `10/10`。

### 4.4 主流程尚未默认走批量发送

- `moments_ext` 仍以逐条 `post_comment()` 为主，批量优化收益未完整落到端到端主链路。

## 5. 距离目标“还差多久”的工程化判断

按目前代码状态，距离目标还差两个里程碑：

1. 技术里程碑：把 piggyback 并发从“可运行”收敛到“稳定 10/10”。
2. 验收里程碑：形成连续多轮 `<1s` 的可复现实验数据。

若并行分支在 `2 -> 4 -> 8 -> 10` 分级压测中稳定，目标已进入可冲刺区间；若出现并发竞争或 TLS 依赖回归，则仍需额外一轮底层修复（例如继续推进 `0xb91e90` 方案）。

## 6. 达标前的最小必做项（P0）

1. 固化硬冲刺脚本：一次下发 10 条，禁用 UI fallback 干扰。
2. 判定收紧：并发可用必须 `succeeded == total`。
3. 分级压测：`2/4/8/10` 并发，每级多轮，输出成功率与耗时分布。
4. 形成统一报表：总耗时、P50/P95、失败分类（SEH/timeout/null return/限流）。

## 7. 达标执行清单（建议按顺序）

### 7.1 先把“验收口径”收紧（当天可完成）

1. `CommentDispatcher` 并发可用判定改成 `succeeded == total`。
2. `PipeServer` 的 batch/parallel/piggyback 返回 `ok` 建议同步改为“全成功才 ok”。
3. 报表固定字段：`total/succeeded/failed/total_latency_ms/per_comment_latency/seh_code`。

目的：避免“部分成功被当作成功”，导致性能结论失真。

### 7.2 建立硬冲刺压测入口（当天可完成）

1. 单命令下发 10 条，禁用 UI fallback 干扰。
2. 固定并发阶梯：`2 -> 4 -> 8 -> 10`。
3. 每档最少 20 轮，输出 P50/P95/失败率。

目的：先拿到可信基线，再谈优化方向。

### 7.3 优先收敛 piggyback 并行稳定性（1-2 天）

1. 在 hook 回调并行分支增加最小诊断：线程 id、每条返回码、SEH、总耗时。
2. 重点观察共享 `arg1` 竞争迹象：并发越高失败率是否阶跃上升。
3. 若 `8/10` 并发开始抖动，优先做“并发上限回退”而不是硬上 10。

目的：先把 10/10 稳定下来，再继续压延迟。

### 7.4 TLS 方案作为 B 计划（仅在并行不稳时推进）

1. 维持当前结论：`0xb91e90` hook 仍属设计态，暂不默认启用。
2. 只有在 piggyback 并行稳定性无法收敛时，才进入函数级 hook 试验。
3. 试验必须带回滚开关，确保一键退回现有路径。

目的：控制复杂度，避免过早进入高风险底层改造。

## 8. 达标判定（建议最终口径）

满足以下全部条件才算“达成目标”：

1. 同一环境连续 >= 50 轮压测。
2. 每轮必须 `10/10` 成功。
3. 总耗时 P95 `< 1s`。
4. 不依赖 UI fallback。
5. 无新增崩溃类型（SEH 分类不扩散）。

## 9. 现实预期（按当前状态）

- 你已经过了最难的“能不能发”阶段，当前卡点是“并行稳定性 + 验收口径”。
- 以现有样本看，最短路径是：
  1. 先把口径收紧并拿到稳定压测数据；
  2. 再做 piggyback 并行收敛；
  3. 最后才决定是否进入 `0xb91e90` 方案。
